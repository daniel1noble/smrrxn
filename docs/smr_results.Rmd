---
title: "Repeatability of thermal plasticity"
author: "Fonti Kar, Daniel Noble, Shinichi Nakagawa"
date: "13/07/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load data, echo = FALSE, include = FALSE}
setwd("~/Dropbox/smrrxn/")

rm(list = ls())

library(ggplot2)
library(lme4)

data <- read.csv("data/data_final/mrrxn_final_v2.csv")
```

### Use Boltzmann constant corrected temperature or z-transformed temperature?

```{r boltz, include = TRUE}
model.1.1 <- lmer(z.log.co2pmin ~ inverseK_incb_temp + z.log.mass + (1+inverseK_incb_temp|id) + (1+inverseK_incb_temp|series), data = data)
summary(model.1.1)
AIC(model.1.1) #No AIC diff in z.log.temp and inverseK temp - stick with inverseK temp

model.1.2 <- lmer(z.log.co2pmin ~ z.incb_temp + z.log.mass + (1+z.incb_temp|id) + (1+z.incb_temp|series), data = data)
summary(model.1.2)
AIC(model.1.2) 

model.1.3 <- lmer(z.log.co2pmin ~ z.log.temp + z.log.mass + (1+z.log.temp|id) + (1+z.log.temp|series), data = data)
summary(model.1.3)
AIC(model.1.3)  
```

### Carry-over effects of previous temperatures using Boltzmann constant corrected temperature predictors

```{r carryover, include = TRUE}
#Carry over effects of prior temps 
model.2.1 <- lmer(z.log.co2pmin ~ inverseK_incb_temp + z.log.mass + inverseK_body_temp + (1+inverseK_incb_temp|id) + (1+inverseK_incb_temp|series), data = data)
summary(model.2.1)
AIC(model.2.1) #body_temp results in the lowest AIC, but doesn't account for prior measurement temps.

model.2.2 <- lmer(z.log.co2pmin ~ inverseK_incb_temp + z.log.mass + inverseK_prior_temp1 + (1+inverseK_incb_temp|id) + (1+inverseK_incb_temp|series), data = data)
summary(model.2.2)
AIC(model.2.2) 
plot(model.2.2)
qqnorm(resid(model.2.2))

model.2.3 <- lmer(z.log.co2pmin ~ inverseK_incb_temp + z.log.mass + inverseK_prior_temp2 + (1+inverseK_incb_temp|id) + (1+inverseK_incb_temp|series), data = data)
summary(model.2.3)
AIC(model.2.3) #lower AIC of the two prior_temp variables - stick with this one for final model
plot(model.2.3)
qqnorm(resid(model.2.3)) 
```

### Repeatabilty of reaction norms from lmer()

```{r rptrxnnorm, include = TRUE}
mod2.3 <- data.frame(VarCorr(model.2.3, comp = "Variance"))

mod2.3[4,4] / (mod2.3[4,4] + mod2.3[1,4]) 

#R slope

mod2.3[5,4] / (mod2.3[5,4] + mod2.3[2,4]) 

#R short term

(mod2.3[4,4] +  mod2.3[1,4]) / (mod2.3[4,4] +  mod2.3[1,4] + mod2.3[7,4]) 

#R long term

mod2.3[4,4] / (mod2.3[4,4] +  mod2.3[1,4] + mod2.3[7,4])

```

### Repeatabilty of reaction norms from lmer()

```{r mcmc rptr, include = TRUE}
Table1 <- read.csv("../output/table/Table1.csv")
Table1
```


### Plotting individual reaction norms across series using final model.2.3

```{r set up for plot, include = FALSE}
#Trying to plot these reaction norms out by groups of 14 lizards

ids_order <- sort(unique(data$id))
g1 <- ids_order[1:14]
g2 <- ids_order[15:28]
g3 <- ids_order[29:42]

predictors <- c("z.log.co2pmin", "inverseK_incb_temp", "z.log.mass", "inverseK_prior_temp2" , "id" ,"series")

plot.data <- data[complete.cases(data[ , predictors ]),]
plot.data$z.log.co2pm_pred <- predict(model.2.3, type = "response")
plot.data$log.co2pm_pred <- (plot.data$z.log.co2pm_pred * sd(plot.data$log.co2pmin)) + mean(plot.data$log.co2pmin)
plot.data$co2pm_pred <- exp(plot.data$log.co2pm_pred)

g1.dat <- plot.data[plot.data$id %in% g1,]
g2.dat <- plot.data[plot.data$id %in% g2,]
g3.dat <- plot.data[plot.data$id %in% g3,]
```

```{r plot reaction norms, include = TRUE}
#g1
ggplot(g1.dat, aes(y = z.log.co2pm_pred, 
                   x = inverseK_incb_temp,
                   group = id, 
                   colour = id)) +
  geom_point() +
  geom_line() + 
  facet_wrap( ~ samp_period, nrow = 2) +
  labs(x = "Boltzmann constant corrected temperature", y = "Predicted z-transformed log CO2 production per minute") + 
  theme_bw() + 
  theme(legend.position = "none")

#g2
ggplot(g2.dat, aes(y = z.log.co2pm_pred, 
                   x = inverseK_incb_temp,
                   group = id, 
                   colour = id)) +
  geom_point() +
  geom_line() + 
  facet_wrap( ~ samp_period, nrow = 2) +
  labs(x = "Boltzmann constant corrected temperature", y = "Predicted z-transformed log CO2 production per minute") + 
  theme_bw() + 
  theme(legend.position = "none")

#g3
ggplot(g3.dat, aes(y = z.log.co2pm_pred, 
                   x = inverseK_incb_temp,
                   group = id, 
                   colour = id)) +
  geom_point() +
  geom_line() + 
  facet_wrap( ~ samp_period, nrow = 2) +
  labs(x = "Boltzmann constant corrected temperature", y = "Predicted z-transformed log CO2 production per minute") + 
  theme_bw() + 
  theme(legend.position = "none")

```

## Plotting individual intercepts and slopes across series

```{r intslope, include = TRUE}
intslope.dat <- read.csv("~/Dropbox/smrrxn/data/intslope.csv")

ggplot(intslope.dat, aes(y = Intercept, 
                         x = inverseK_incb_temp, 
                         colour = id)) +
  geom_point() +
  scale_x_continuous(name = "Slope for temperature")+ 
  facet_wrap( ~ samp_period, nrow = 2) +
  theme_bw() +
  theme(legend.position = "none")
```

## How repeatable are responses across temperatures

```{r rptr at temp, include = FALSE} 

predictors <- c("z.log.co2pmin", "z.log.mass", "inverseK_prior_temp2", "id", "series")

unique(data$incb_temp)

twtwo_dat <- data[data$incb_temp == 22,]
model.3.1 <- lmer(z.log.co2pmin ~ z.log.mass + inverseK_prior_temp2 + samp_period + (1|id), data = twtwo_dat)
summary(model.3.1)
plot(model.3.1)
qqnorm(resid(model.3.1)) 
mod3.1 <- data.frame(VarCorr(model.3.1, comp = "Variance"))
mod3.1[1,4] / (mod3.1[2,4] + mod3.1[1,4]) 


twfr_dat <- data[data$incb_temp == 24,]
model.3.2 <- lmer(z.log.co2pmin ~ z.log.mass + inverseK_prior_temp2 + samp_period + (1|id), data = twfr_dat)
summary(model.3.2)
plot(model.3.2)
qqnorm(resid(model.3.2))
mod3.2 <- data.frame(VarCorr(model.3.2, comp = "Variance"))
mod3.2[1,4] / (mod3.2[2,4] + mod3.2[1,4]) 

twsx_dat <- data[data$incb_temp == 26,]
model.3.3 <- lmer(z.log.co2pmin ~ z.log.mass + inverseK_prior_temp2 + samp_period + (1|id), data = twsx_dat)
summary(model.3.3)
plot(model.3.3)
qqnorm(resid(model.3.3))
mod3.3 <- data.frame(VarCorr(model.3.3, comp = "Variance"))
mod3.3[1,4] / (mod3.3[2,4] + mod3.3[1,4]) 

twet_dat <- data[data$incb_temp == 28,]
model.3.4 <- lmer(z.log.co2pmin ~ z.log.mass + inverseK_prior_temp2 + samp_period + (1|id), data = twet_dat)
summary(model.3.4)
plot(model.3.4)
qqnorm(resid(model.3.4))
mod3.4 <- data.frame(VarCorr(model.3.4, comp = "Variance"))
mod3.4[1,4] / (mod3.4[2,4] + mod3.4[1,4]) 

thrt_dat <- data[data$incb_temp == 30,]
model.3.5 <- lmer(z.log.co2pmin ~ z.log.mass + inverseK_prior_temp2 + samp_period + (1|id), data = thrt_dat)
summary(model.3.5)
plot(model.3.5)
qqnorm(resid(model.3.5))
mod3.5 <- data.frame(VarCorr(model.3.5, comp = "Variance"))
mod3.5[1,4] / (mod3.5[2,4] + mod3.5[1,4]) 

thrttw_dat <- data[data$incb_temp == 32,]
model.3.6 <- lmer(z.log.co2pmin ~ z.log.mass + inverseK_prior_temp2 + samp_period + (1|id), data = thrttw_dat)
summary(model.3.6)
plot(model.3.6)
qqnorm(resid(model.3.6))
mod3.6 <- data.frame(VarCorr(model.3.6, comp = "Variance"))
mod3.6[1,4] / (mod3.6[2,4] + mod3.6[1,4]) 

rpt.plot <- data.frame(temp = sort(unique(data$incb_temp)),
              rpt = c( mod3.1[1,4] / (mod3.1[2,4] + mod3.1[1,4]),
                       mod3.2[1,4] / (mod3.2[2,4] + mod3.2[1,4]),
                       mod3.3[1,4] / (mod3.3[2,4] + mod3.3[1,4]),
                       mod3.4[1,4] / (mod3.4[2,4] + mod3.4[1,4]),
                       mod3.5[1,4] / (mod3.5[2,4] + mod3.5[1,4]),
                       mod3.6[1,4] / (mod3.6[2,4] + mod3.6[1,4])))

```

```{r rpt at temp plot, include = TRUE}

ggplot(rpt.plot, aes(y = rpt,
                     x = temp)) +
  geom_point() +
  geom_line() +
  scale_x_continuous(name = "Temperature",
                     limits= c(22, 32),
                     breaks= seq(22,32,2)) + 
  scale_y_continuous(name = "Adjusted repeatability",
                     limits = c(0, 0.25)) + 
  theme_bw() 
  ```